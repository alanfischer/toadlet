<html>
<head>
<title>Toadlet Example</title>
</head>
<canvas width="512" height="512" id="canvas" oncontextmenu="return false;"></canvas>
</body>

<script type="text/javascript">
var renderDevice;
var engine;
var scene;
var cameraComponent;

var update=function(){
	var t=(new Date()).getTime()/1000.0;
	var camera=cameraComponent.getCamera();
	
	cameraComponent.setLookAt([Math.cos(t)*10,Math.sin(t)*10,10],[0,0,0],[0,0,1]);
	
	scene.update(33);
	
	renderDevice.beginScene();
		camera.render(renderDevice,scene,null);
	renderDevice.endScene();

	window.setTimeout(update,33);
};

var init=function(){
	var renderTarget=toadlet.new_EGLWindowRenderTarget(document.getElementById("canvas"));
	renderDevice=toadlet.new_GLES2RenderDevice();
	renderDevice.create(renderTarget,0);

	engine=new toadlet.Engine();
	engine.setRenderDevice(renderDevice);
	engine.installHandlers();
	
	scene=new toadlet.Scene(engine);
	var root=scene.getRoot();

	var camera=new toadlet.Camera(engine);
	var cameraNode=new toadlet.Node(scene);
	cameraComponent=new toadlet.CameraComponent(camera);
	cameraNode.attach(cameraComponent);
	root.attach(cameraNode);
	cameraComponent.setLookAt([0,10,10],[0,0,0],[0,0,1]);
	cameraNode.delete();
	camera.delete();
	
	var request=toadlet.ResourceRequest.implement({
		resourceReady: function(resource){
			var material=engine.createDiffuseMaterial(toadlet.toTexture(resource),null);
			var mesh=engine.createTorusMesh(2,1,6,6,material);
			var meshComponent=new toadlet.MeshComponent(engine);
			var meshNode=new toadlet.Node(scene);
			meshComponent.setMeshWithMesh(mesh);
			meshNode.attach(meshComponent);
			root.attach(meshNode);
			meshNode.delete();
			meshComponent.delete();
			mesh.delete();
			material.delete();
			resource.delete();
		},
		resourceException: function(ex){
			console.log(ex.getError());
		}
	});
	
	var xmlHTTPArchive=toadlet.Archive.implement({
		openStream: function(name,request){
			var xmlHttp=new XMLHttpRequest();
			xmlHttp.open("GET",name);
			xmlHttp.onreadystatechange=function(){
				if(xmlHttp.readyState==4){
					if(xmlHttp.status==200){
						request.stringStreamReady(xmlHttp.responseText);
						request.delete();
					}
					else{
						request.streamException(Error.unknown());
						request.delete();
					}
				}
			}
			xmlHttp.ontimeout=function(){
				request.streamException(Error.unknown());
				request.delete();
			}
			xmlHttp.send();
			return true;
		},
		openResource: function(name,request){
			return false;
		}
	});

	var domTextureArchive=toadlet.Archive.implement({
		openStream: function(name,request){
			return false;
		},
		openResource: function(name,request){
			var image=new Image();
			image.onload=function(){
				// TODO: Can we cleanly get the texture handle from emscripten?
				var gl=toadlet.ctx;
				var target,handle;
				var oldBindTexture=gl.bindTexture.bind(gl);
				gl.bindTexture=function(gltarget,glhandle){
					target=gltarget;
					handle=glhandle;
					oldBindTexture(gltarget,glhandle);
				};

				var textureManager=engine.getTextureManager();
				var textureFormat=new toadlet.TextureFormat(toadlet.Dimension.Dimension_D2.value,toadlet.Format.Format_RGBA_8.value,image.naturalWidth,image.naturalHeight,1,0);
				var texture=textureManager.createTexture(textureFormat);
				gl.bindTexture(target,handle);
				gl.texImage2D(target,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);
				gl.generateMipmap(target);
				gl.bindTexture(target,null);
				textureManager.manage(texture,name);
				request.resourceReady(texture);
				texture.delete();
				request.delete();
				
				gl.bindTexture=oldBindTexture;
			}
			image.onerror=function(){
				request.resourceException(Error.unknown());
				request.delete();
			}
			image.src=name;
			return true;
		}
	});
	
	var archiveManager=engine.getArchiveManager();
	archiveManager.manage(xmlHTTPArchive,"XMLHttpRequest");

	var textureManager=engine.getTextureManager();
	textureManager.addResourceArchive(domTextureArchive);
	textureManager.find("http://people.sc.fsu.edu/~jburkardt/data/bmp/lena.bmp",request,null);
	
	update();
};

var script=document.createElement("script");
script.type="text/javascript";
script.src="toadlet.js";
script.onreadystatechange=init;
script.onload=init;
document.getElementsByTagName("head")[0].appendChild(script);

</script>
</html>
